# Документация: приложение «Пользователи» (users)

Документ описывает модель пользователя и раздел админ-панели для управления пользователями в проекте PM.Meetup. Назначение — дать заказчику и разработчикам единое понимание: кто такой пользователь, как он создаётся, как устроен вход и админка.

---

## 1. Назначение приложения

Приложение **users** отвечает за:

- **Учётные записи** — кто может войти на сайт и в админ-панель.
- **Роли** — участник, организатор, модератор, администратор, суперадминистратор (для разграничения прав в будущем).
- **Вход по email** — логином служит email, а не отдельное поле «логин».
- **Управление пользователями в админке** — просмотр, создание, редактирование, блокировка.

В проекте используется **кастомная модель пользователя**: не стандартный `django.contrib.auth.models.User`, а своя модель `User` в приложении `users`. В настройках проекта указано: `AUTH_USER_MODEL = 'users.User'`. Все ссылки на «текущего пользователя» в других приложениях (события, новости, регистрации) обращаются к этой модели.

---

## 2. Модель User (пользователь)

### 2.1. Базовый класс

Модель наследуется от **AbstractUser** (Django). От неё автоматически приходят:

- **password** — пароль (хранится в виде хеша).
- **last_login** — дата и время последнего входа.
- **is_superuser** — флаг «суперадминистратор» (все права без явной выдачи).
- **first_name**, **last_name** — имя и фамилия.
- **is_staff** — может ли пользователь заходить в админ-панель.
- **is_active** — активна ли учётная запись (если False, войти нельзя).
- **date_joined** — дата создания записи (стандартное поле Django).
- Связи с **группами** и **правами** (groups, user_permissions).

Поле **username** в нашей модели отключено: в коде указано `username = None`. Для входа используется только **email**.

### 2.2. Поля, добавленные в проекте

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| **email** | EmailField, уникальный | Да | Адрес электронной почты. Используется как **логин** при входе. |
| **phone** | CharField(20) | Нет | Номер телефона. |
| **avatar** | ImageField | Нет | Фото профиля. Сохраняется в каталог `media/avatars/`. |
| **role** | CharField, выбор из списка | Да (есть значение по умолчанию) | Роль пользователя в системе (см. ниже). |
| **is_blocked** | BooleanField | Нет (по умолчанию False) | Заблокирован ли пользователь. Можно использовать для блокировки без удаления. |
| **created_at** | DateTimeField | Авто | Дата и время регистрации (заполняется при создании). |

### 2.3. Роли (поле role)

Возможные значения заданы в модели и отображаются в админке так:

| Значение в БД | Отображаемое название |
|---------------|------------------------|
| member | Участник |
| organizer | Организатор |
| moderator | Модератор |
| admin | Администратор |
| superadmin | Суперадминистратор |

- **Участник (member)** — значение по умолчанию для всех, кто регистрируется на сайте через форму регистрации.
- **Суперадминистратор (superadmin)** — автоматически выставляется только при создании пользователя командой `createsuperuser` (или явным вызовом `create_superuser` в коде). Обычная регистрация суперадмина не создаёт.

Остальные роли (организатор, модератор, администратор) предназначены для будущего разграничения прав согласно ТЗ; на уровне модели и админки они пока только хранятся и отображаются.

### 2.4. Специальные настройки модели

- **USERNAME_FIELD = "email"**  
  Django использует поле **email** как идентификатор пользователя при входе (логин). Поэтому в форме входа и в команде `createsuperuser` запрашивается email, а не «логин».

- **REQUIRED_FIELDS = ["first_name", "last_name"]**  
  При создании суперадмина через `createsuperuser` дополнительно обязательно запрашиваются имя и фамилия (пароль и email запрашиваются всегда).

- **objects = UserManager()**  
  Для модели задан свой менеджер (см. раздел 3). Через него создаются обычные пользователи и суперадмины.

- **ordering = ["-created_at"]**  
  В списках (например, в админке) пользователи по умолчанию сортируются по дате регистрации, сначала новые.

---

## 3. Менеджер пользователей (UserManager)

Чтобы вход был по **email**, а не по **username**, стандартного менеджера Django недостаточно: у него методы `create_user` и `create_superuser` ожидают первым аргументом именно username. Поэтому в приложении описан свой **UserManager**, унаследованный от **BaseUserManager**.

### 3.1. create_user(email, password=None, **extra_fields)

Используется при **обычной регистрации** пользователя (форма на сайте, API регистрации и т.п.):

1. Проверяется наличие email.
2. Email нормализуется (приведение к нижнему регистру и т.д.).
3. Создаётся экземпляр модели `User` с переданным email и всеми дополнительными полями из `extra_fields`.
4. Пароль сохраняется через `set_password()` (в виде хеша).
5. Пользователь сохраняется в БД.

**Роль при этом не задаётся** — подставляется значение по умолчанию из модели: **member (Участник)**. То есть каждый зарегистрировавшийся через сайт по умолчанию получает роль «Участник».

### 3.2. create_superuser(email, password=None, **extra_fields)

Используется **только** при создании суперадминистратора:

- Команда: `python manage.py createsuperuser`.
- Или явный вызов в коде: `User.objects.create_superuser(email=..., password=...)`.

Внутри метода:

1. В `extra_fields` подставляются: `is_staff=True`, `is_superuser=True`, `role="superadmin"`.
2. Проверяется, что флаги суперадмина не переопределены на False.
3. Вызывается `create_user(email, password, **extra_fields)` — то есть создаётся тот же пользователь, но уже с правами суперадмина и ролью «Суперадминистратор».

Итог для заказчика:

- **Обычная регистрация** → всегда вызывается только `create_user` → роль «Участник».
- **Создание суперадмина** → вызывается только `create_superuser` → роль «Суперадминистратор» и полные права. Случайно «сделать» суперадмином при регистрации через сайт нельзя.

---

## 4. Админ-панель (раздел «Пользователи»)

В админке модель `User` зарегистрирована через стандартный класс **UserAdmin** (Django), расширенный под нашу модель. Файл: `apps/users/admin.py`.

### 4.1. Список пользователей

- **Колонки:** email, имя, фамилия, роль, заблокирован, дата регистрации.
- **Сортировка по умолчанию:** по дате регистрации (сначала новые).
- **Фильтры справа:** по роли, по признаку «заблокирован», по признаку «сотрудник» (is_staff).
- **Поиск:** по email, имени, фамилии.

### 4.2. Карточка пользователя (просмотр/редактирование)

Поля сгруппированы в блоки:

1. **Без названия** — email и пароль (пароль показывается в виде хеша, его можно сменить через «эту форму» по ссылке).
2. **Личные данные** — имя, фамилия, телефон, аватар.
3. **Права** — роль, заблокирован, активен, сотрудник (доступ в админку), суперадминистратор.
4. **Даты** — последний вход, дата регистрации (дата регистрации только для чтения).

Так заказчик видит все данные пользователя и может изменить роль, заблокировать или разблокировать, включить/выключить доступ в админку.

### 4.3. Добавление нового пользователя

При нажатии «Добавить пользователя» показывается форма с полями:

- Email  
- Имя  
- Фамилия  
- Пароль  
- Подтверждение пароля  

Поля «Роль», «Сотрудник» и т.д. после сохранения можно задать в карточке пользователя. Так администратор может вручную создавать пользователей (в том числе с нужной ролью) и сразу задавать им пароль.

### 4.4. Вход в админку

Вход в админ-панель выполняется по **email** и **паролю** (не по отдельному «логину»). Это следствие настройки `USERNAME_FIELD = "email"` в модели.

---

## 5. Связь с остальным проектом

- В настройках проекта указано **AUTH_USER_MODEL = 'users.User'**. Все ссылки на «пользователя» в других приложениях (события, новости, регистрации на мероприятия) ссылаются на эту модель.
- Модели **EventRegistration**, **NewsArticle** (автор) и другие при необходимости хранят связь с пользователем через внешний ключ на `settings.AUTH_USER_MODEL` (то есть на `users.User`).

---

## 6. Краткая сводка для заказчика

| Вопрос | Ответ |
|--------|--------|
| Чем пользователь входит в систему? | Email и пароль (логин = email). |
| Кто такой «Участник»? | Любой, кто зарегистрировался через сайт; роль по умолчанию. |
| Кто такой «Суперадминистратор»? | Тот, кого создали через команду `createsuperuser` или через код `create_superuser`. При обычной регистрации эта роль не выдаётся. |
| Где управлять пользователями? | В админ-панели, раздел «Пользователи». |
| Можно ли блокировать без удаления? | Да, флаг «Заблокирован» (is_blocked). |
| Где хранятся фото? | В каталоге `media/avatars/`. |
